<div x-data="{ new_address: false }" class="bg-white">
  <div class="mx-auto max-w-2xl px-4 py-16 sm:px-6 sm:py-24 lg:max-w-7xl lg:px-8">
    <div class="mb-8">
      <h1 class="text-4xl font-bold text-center leading-16 sm:text-2xl lg:text-5xl">{{ 'customer.addresses.title' | t }}</h1>
    </div>
    <div class="flex flex-col md:flex-row items-center justify-between my-5 gap-4">
        <button x-on:click="new_address = true" type="button" class="text-white font-medium bg-gray-700 hover:bg-gray-900 px-6 py-2">{{ 'customer.addresses.title' | t }}</button>
        <a href="{{ routes.account_url }}" class="text-blue-600 hover:text-blue-800 font-medium underline">{{ 'customer.addresses.back_to_account' | t }}</a>
    </div>
    <div class="p-6">
    </div>

    <div x-cloak x-show="new_address" class="fixed inset-0 z-10 w-screen overflow-y-auto bg-gray-900/75 transition-opacity">
      <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
        <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
          <div class="bg-white p-6">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-lg font-medium">
                {{ 'customer.addresses.add_new' | t }}
              </h2>
              <button x-on:click="new_address = false" class="text-gray-500 cursor-pointer">{% render 'icon-close' %}</button>
            </div>

            {% form 'customer_address', customer.new_address, class: 'space-y-6' %}
              <div>
                <label for="address_fname_{{ form.id }}" class="block text-sm/6 font-medium text-gray-900">
                  {{ 'customer.addresses.first_name' | t }}
                </label>
                <div class="mt-2">
                  <input 
                    type="text" 
                    name="address[first_name]" 
                    id="address_fname_{{ form.id }}" 
                    value="{{ form.first_name }}" 
                    class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6"
                  >
                </div>
              </div>
              <div>
                <label for="address_lname_{{ form.id }}" class="block text-sm/6 font-medium text-gray-900">
                  {{ 'customer.addresses.last_name' | t }}
                </label>
                <div class="mt-2">
                  <input 
                    type="text" 
                    name="address[last_name]" 
                    id="address_lname_{{ form.id }}" 
                    value="{{ form.last_name }}" 
                    class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6"
                  >
                </div>
              </div>
              <div>
                <label for="address_company_{{ form.id }}" class="block text-sm/6 font-medium text-gray-900">
                  {{ 'customer.addresses.company' | t }}
                </label>
                <div class="mt-2">
                  <input 
                    type="text" 
                    name="address[company]" 
                    id="address_company_{{ form.id }}" 
                    value="{{ form.company }}" 
                    class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6"
                  >
                </div>
              </div>
              <div>
                <label for="address_address2_{{ form.id }}" class="block text-sm/6 font-medium text-gray-900">
                  {{ 'customer.addresses.address1' | t }}
                </label>
                <div class="mt-2">
                  <input 
                    type="text" 
                    name="address[address1]" 
                    id="address_address1_{{ form.id }}" 
                    value="{{ form.address1 }}" 
                    class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6"
                  >
                </div>
              </div>
              <div>
                <label for="address_address2_{{ form.id }}" class="block text-sm/6 font-medium text-gray-900">
                  {{ 'customer.addresses.address2' | t }}
                </label>
                <div class="mt-2">
                  <input 
                    type="text" 
                    name="address[address2]" 
                    id="address_address2_{{ form.id }}" 
                    value="{{ form.address2 }}" 
                    class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6"
                  >
                </div>
              </div>
              <div>
                <label for="address_city_{{ form.id }}" class="block text-sm/6 font-medium text-gray-900">
                  {{ 'customer.addresses.city' | t }}
                </label>
                <div class="mt-2">
                  <input 
                    type="text" 
                    name="address[city]" 
                    id="address_city_{{ form.id }}" 
                    value="{{ form.city }}" 
                    class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6"
                  >
                </div>
              </div>
              <div>
                <label for="address_zip_{{ form.id }}" class="block text-sm/6 font-medium text-gray-900">
                  {{ 'customer.addresses.zip' | t }}
                </label>
                <div class="mt-2">
                  <input 
                    type="text" 
                    name="address[zip]" 
                    id="address_zip_{{ form.id }}" 
                    value="{{ form.zip }}" 
                    class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6"
                  >
                </div>
              </div>
              <div>
                <label for="address_country_{{ form.id }}" class="block text-sm/6 font-medium text-gray-900">
                  {{ 'customer.addresses.country' | t }}
                </label>
                <div class="mt-2 grid grid-cols-1">
                  <select 
                    name="address[country]" 
                    id="address_country_{{ form.id }}" 
                    value="{{ form.country }}" 
                    class="col-start-1 row-start-1 w-full appearance-none rounded-md bg-white py-1.5 pr-8 pl-3 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6"
                    data-id="{{ form.id }}"
                    data-country-selector
                  >
                    {{ all_country_option_tags }}
                  </select>
                  {% render 'icon-dropdown', svg_class: "pointer-events-none col-start-1 row-start-1 mr-2 size-5 self-center justify-self-end text-gray-500 sm:size-4" %}
                </div>
              </div>
              <div>
                <label for="address_province_{{ form.id }}" class="block text-sm/6 font-medium text-gray-900">
                  {{ 'customer.addresses.province' | t }}
                </label>
                <div class="mt-2 grid grid-cols-1">
                  <select 
                    name="address[province]" 
                    id="address_province_{{ form.id }}" 
                    value="{{ form.province }}" 
                    class="col-start-1 row-start-1 w-full appearance-none rounded-md bg-white py-1.5 pr-8 pl-3 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6"
                  >
                  </select>
                  {% render 'icon-dropdown', svg_class: "pointer-events-none col-start-1 row-start-1 mr-2 size-5 self-center justify-self-end text-gray-500 sm:size-4" %}
                </div>
              </div>
              <div>
                <label for="address_phone_{{ form.id }}" class="block text-sm/6 font-medium text-gray-900">
                  {{ 'customer.addresses.phone' | t }}
                </label>
                <div class="mt-2">
                  <input 
                    type="tel" 
                    name="address[phone]" 
                    id="address_phone_{{ form.id }}" 
                    value="{{ form.phone }}" 
                    class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6"
                  >
                </div>
              </div>
              <div>
                {{ form.set_as_default_checkbox }}
                <label for="address_default_address_{{ form.id }}" class="uppercase text-gray-700 text-xs font-medium mb-2">{{ 'customer.addresses.set_default' | t }}</label>
              </div>
              <div class="grid grid-cols-2 gap-x-6">
                <button type="submit" class="flex w-full justify-center rounded-md bg-green-500 px-3 py-1.5 text-sm/6 font-semibold text-white shadow-xs cursor-pointer hover:bg-green-400 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">
                  {{ 'customer.addresses.add_new' | t }}
                </button>
                <button type="submit" class="flex w-full justify-center rounded-md bg-white ring-gray-300 ring ring-inset ring-offset-0 px-3 py-1.5 text-sm/6 font-semibold text-gray-900 shadow-xs cursor-pointer hover:bg-gray-50 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">
                  {{ 'customer.addresses.cancel' | t }}
                </button>
              </div>
            {%  endform %}
          </div>
        </div>
      </div>
    </div>

    <div>
      {% paginate customer.addresses by 10 %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 lg:gap-12 p-4 md:p-12">
          {% for address in customer.addresses %}
            <div x-data="{ address_{{ address.id }}: false }">
              <div class="relative flex flex-col text-center border p-2">
                {% if address == customer.default_address %}
                  <span class="text-xs font-medium text-white bg-green-700 px-4 py-2">
                    {{ 'customer.addresses.default' | t }}
                  </span>
                {% endif %}

                <div class="my-8 h-full">
                  {{ address | format_address }}
                </div>

                <div class="flex flex-row gap-2">
                  <button 
                    x-on:click="address_{{ address.id }} = true" 
                    class="w-full text-xs text-white bg-gray-700 hover:bg-gray-900 font-medium py-2"
                  >
                    {{ 'customer.addresses.edit' | t }}
                  </button>
                  <button 
                    class="w-full text-xs font-medium text-gray-700 border py-2"
                    data-delete-address
                    data-url="{{ address.url }}"
                  >
                    {{ 'customer.addresses.delete' | t }}
                  </button>
                </div>

                <form method="post" action="{{ address.url }}">
                  <input type="hidden" name="_method" value="delete">
                </form>
              </div>

              <div x-cloak x-show="address_{{ address.id }}" class="h-full w-full fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto z-50">
                <div class="relative max-w-md mx-auto bg-white border border-gray-200 top-20 p-6">
                  <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-medium">
                      {{ 'customer.addresses.edit_address' | t }}
                    </h2>
                    <button x-on:click="address_{{ address.id }} = false" class="text-gray-500 cursor-pointer">{% render 'icon-close' %}</button>
                  </div>
          
                  {% form 'customer_address', address, class: 'space-y-6' %}
                    <div>
                      <label for="address_fname_{{ form.id }}" class="block text-sm/6 font-medium text-gray-900">
                        {{ 'customer.addresses.first_name' | t }}
                      </label>
                      <div class="mt-2">
                        <input 
                          type="text" 
                          name="address[first_name]" 
                          id="address_fname_{{ form.id }}" 
                          value="{{ form.first_name }}" 
                          class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6"
                        >
                      </div>
                    </div>
                    <div>
                      <label for="address_lname_{{ form.id }}" class="block text-sm/6 font-medium text-gray-900">
                        {{ 'customer.addresses.last_name' | t }}
                      </label>
                      <div class="mt-2">
                        <input 
                          type="text" 
                          name="address[last_name]" 
                          id="address_lname_{{ form.id }}" 
                          value="{{ form.last_name }}" 
                          class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6"
                        >
                      </div>
                    </div>
                    <div>
                      <label for="address_company_{{ form.id }}" class="block text-sm/6 font-medium text-gray-900">
                        {{ 'customer.addresses.company' | t }}
                      </label>
                      <div class="mt-2">
                        <input 
                          type="text" 
                          name="address[company]" 
                          id="address_company_{{ form.id }}" 
                          value="{{ form.company }}" 
                          class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6"
                        >
                      </div>
                    </div>
                    <div>
                      <label for="address_address2_{{ form.id }}" class="block text-sm/6 font-medium text-gray-900">
                        {{ 'customer.addresses.address1' | t }}
                      </label>
                      <div class="mt-2">
                        <input 
                          type="text" 
                          name="address[address1]" 
                          id="address_address1_{{ form.id }}" 
                          value="{{ form.address1 }}" 
                          class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6"
                        >
                      </div>
                    </div>
                    <div>
                      <label for="address_address2_{{ form.id }}" class="block text-sm/6 font-medium text-gray-900">
                        {{ 'customer.addresses.address2' | t }}
                      </label>
                      <div class="mt-2">
                        <input 
                          type="text" 
                          name="address[address2]" 
                          id="address_address2_{{ form.id }}" 
                          value="{{ form.address2 }}" 
                          class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6"
                        >
                      </div>
                    </div>
                    <div>
                      <label for="address_city_{{ form.id }}" class="block text-sm/6 font-medium text-gray-900">
                        {{ 'customer.addresses.city' | t }}
                      </label>
                      <div class="mt-2">
                        <input 
                          type="text" 
                          name="address[city]" 
                          id="address_city_{{ form.id }}" 
                          value="{{ form.city }}" 
                          class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6"
                        >
                      </div>
                    </div>
                    <div>
                      <label for="address_zip_{{ form.id }}" class="block text-sm/6 font-medium text-gray-900">
                        {{ 'customer.addresses.zip' | t }}
                      </label>
                      <div class="mt-2">
                        <input 
                          type="text" 
                          name="address[zip]" 
                          id="address_zip_{{ form.id }}" 
                          value="{{ form.zip }}" 
                          class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6"
                        >
                      </div>
                    </div>
                    <div>
                      <label for="address_country_{{ form.id }}" class="block text-sm/6 font-medium text-gray-900">
                        {{ 'customer.addresses.country' | t }}
                      </label>
                      <div class="mt-2 grid grid-cols-1">
                        <select 
                          name="address[country]" 
                          id="address_country_{{ form.id }}" 
                          value="{{ form.country }}" 
                          class="col-start-1 row-start-1 w-full appearance-none rounded-md bg-white py-1.5 pr-8 pl-3 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6"
                          data-id="{{ form.id }}"
                          data-country-selector
                        >
                          {{ all_country_option_tags }}
                        </select>
                        {% render 'icon-dropdown', svg_class: "pointer-events-none col-start-1 row-start-1 mr-2 size-5 self-center justify-self-end text-gray-500 sm:size-4" %}
                      </div>
                    </div>
                    <div>
                      <label for="address_province_{{ form.id }}" class="block text-sm/6 font-medium text-gray-900">
                        {{ 'customer.addresses.province' | t }}
                      </label>
                      <div class="mt-2 grid grid-cols-1">
                        <select 
                          name="address[province]" 
                          id="address_province_{{ form.id }}" 
                          value="{{ form.province }}" 
                          class="col-start-1 row-start-1 w-full appearance-none rounded-md bg-white py-1.5 pr-8 pl-3 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6"
                        >
                        </select>
                        {% render 'icon-dropdown', svg_class: "pointer-events-none col-start-1 row-start-1 mr-2 size-5 self-center justify-self-end text-gray-500 sm:size-4" %}
                      </div>
                    </div>
                    <div>
                      <label for="address_phone_{{ form.id }}" class="block text-sm/6 font-medium text-gray-900">
                        {{ 'customer.addresses.phone' | t }}
                      </label>
                      <div class="mt-2">
                        <input 
                          type="tel" 
                          name="address[phone]" 
                          id="address_phone_{{ form.id }}" 
                          value="{{ form.phone }}" 
                          class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6"
                        >
                      </div>
                    </div>
                    <div>
                      {{ form.set_as_default_checkbox }}
                      <label for="address_default_address_{{ form.id }}" class="uppercase text-gray-700 text-xs font-medium mb-2">{{ 'customer.addresses.set_default' | t }}</label>
                    </div>
                    <div class="grid grid-cols-2 gap-x-6">
                      <button type="submit" class="flex w-full justify-center rounded-md bg-green-500 px-3 py-1.5 text-sm/6 font-semibold text-white shadow-xs cursor-pointer hover:bg-green-400 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">
                        {{ 'customer.addresses.edit' | t }}
                      </button>
                      <button type="submit" class="flex w-full justify-center rounded-md bg-white ring-gray-300 ring ring-inset ring-offset-0 px-3 py-1.5 text-sm/6 font-semibold text-gray-900 shadow-xs cursor-pointer hover:bg-gray-50 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">
                        {{ 'customer.addresses.cancel' | t }}
                      </button>
                    </div>
                  {%  endform %}
                </div>
              </div>

            </div>
          {% endfor %}
        </div>
          
      {% endpaginate %}
    </div>
  </div>
</div>

<script>
  class CustomerAddress {
      constructor() {
          this.initCustomerAddress();
          this.customerAddressesSelector();
          this.initDeleteAddressButtons();
      }

      initDeleteAddressButtons() {
        const deleteButtons = document.querySelectorAll("button[data-delete-address]");

        if(deleteButtons.length < 1) return;

        deleteButtons.forEach(button => {
          button.addEventListener("click", function(e) {
            var url = this.dataset.url;

            var confirmation = window.confirm("Do you wish to delete?");

            if(confirmation) {
              document.querySelector(`form[action="${url}"]`).submit();
            }
     
          })
        })
      }

      initCustomerAddress() {
          const allAddressesSelector = document.querySelectorAll("select[data-country-selector]");
          if(allAddressesSelector.length < 1) return;

          //console.log(allAddressesSelector);

          allAddressesSelector.forEach(select => {
              var selectedCountry = this.getSelectedCountry(select);

              if(!selectedCountry) return;

              var provinces = selectedCountry.dataset.provinces;
              var arrayOfProvince = JSON.parse(provinces);

              var provinceSelector = document.querySelector(`#address_province_${select.dataset.id}`);

              if(arrayOfProvince.length < 1) {
                  provinceSelector.setAttribute('disabled', 'disabled');
              } else {
                  provinceSelector.removeAttribute('disabled');
              }

              provinceSelector.innerHTML = '';
              var options = '';
              for(var index = 0; index < arrayOfProvince.length; index++) {
                  if(arrayOfProvince[index][0] === provinceSelector.getAttribute('value')) {
                      options += `<option value="${arrayOfProvince[index][0]}" selected>${arrayOfProvince[index][0]}</option>`;
                  } else {
                      options += `<option value="${arrayOfProvince[index][0]}">${arrayOfProvince[index][0]}</option>`;
                  }
              }

              provinceSelector.innerHTML = options;
          })
      }

      getSelectedCountry(select) {
          var option, selectedOption;
          for(var index = 0; index < select.options.length; index++) {
              option = select.options[index];

              if(option.value === select.getAttribute('value')) {
                  selectedOption = option;
                  selectedOption.setAttribute('selected', 'selected');
                  break;
              }
          }

          return selectedOption;
      }
  
      customerAddressesSelector() {
          const addressesSelector = document.querySelectorAll("select[data-country-selector]");
          if(addressesSelector.length < 1) return;

          addressesSelector.forEach(select => {
              select.addEventListener('change', function(e) {
                  var provinces = this.options[this.selectedIndex].dataset.provinces;
                  var arrayOfProvince = JSON.parse(provinces);

                  var provinceSelector = document.querySelector(`#address_province_${this.dataset.id}`);

                  if(arrayOfProvince.length < 1) {
                      provinceSelector.setAttribute('disabled', 'disabled');
                  } else {
                      provinceSelector.removeAttribute('disabled');
                  }

                  provinceSelector.innerHTML = '';
                  var options = '';
                  for(var index = 0; index < arrayOfProvince.length; index++ ) {
                      options += `<option value="${arrayOfProvince[index][0]}" selected="selected">${arrayOfProvince[index][0]}</option>`;
                  }

                  provinceSelector.innerHTML = options;
              });
          });
      }
  }

  const customerAddress = new CustomerAddress();
</script>